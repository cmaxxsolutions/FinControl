<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinControl - Controle Financeiro Pessoal</title>
    
    <!-- Tailwind CSS (Crítico para a renderização inicial, fica no head) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Configuração do Modo Escuro */
        :root { color-scheme: light; }
        .dark { color-scheme: dark; }

        /* Animações */
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out forwards; }
        
        @keyframes slide-down {
            from { transform: translateY(-20%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-down { animation: slide-down 0.3s ease-out forwards; }
        
        @keyframes fade-in-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
        
        @keyframes scale-in {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-scale-in { animation: scale-in 0.2s ease-out forwards; }

        /* Spinner */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900">

    <!-- Root App Container -->
    <div id="app">
        <!-- O App será renderizado aqui pelo JavaScript -->
        <div class="flex items-center justify-center h-screen w-screen">
            <div class="loader animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        </div>
    </div>

    <!-- Scripts Otimizados (Carregados após o HTML) -->
    
    <!-- Chart.js (para gráficos) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    
    <!-- Lucide Icons (para ícones) -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-icons@0.320.0/dist/lucide.min.js"></script>

    <!-- Firebase SDKs e Lógica do App (type="module" age como defer) -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            collection, 
            onSnapshot, 
            query, 
            deleteDoc, 
            updateDoc,
            serverTimestamp,
            getDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // setLogLevel('Debug'); // Habilite para logs detalhados

        // --- ESTADO GLOBAL DA APLICAÇÃO ---
        let state = {
            currentPage: 'loading',
            user: null,
            appUser: null,
            userId: null,
            isAuthReady: false,
            notification: null, // { message, type }
            theme: localStorage.getItem('theme') || 'light',
            transactions: [],
            userList: [],
            chartInstances: {
                monthlyChart: null,
                categoryChart: null
            },
            listeners: { // Para limpar os listeners do onSnapshot
                transactions: null,
                userList: null
            }
        };

        // --- ELEMENTO ROOT ---
        const appRoot = document.getElementById('app');

        // --- FUNÇÕES DE RENDERIZAÇÃO (Substituindo Componentes React) ---

        // Função principal que redesenha o app
        function renderApp() {
            // Aplica o tema
            if (state.theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            let content = '';
            const page = state.currentPage;

            // Roteador principal
            if (!state.isAuthReady || page === 'loading') {
                content = renderLoadingSpinner(true);
            } else if (['login', 'register'].includes(page)) {
                content = renderAuthLayout(
                    page === 'login' ? renderLoginPage() : renderRegisterPage()
                );
            } else {
                let pageContent = '';
                switch (page) {
                    case 'dashboard': pageContent = renderDashboardPage(); break;
                    case 'profile': pageContent = renderProfilePage(); break;
                    case 'admin': pageContent = renderAdminPage(); break;
                    case 'about': pageContent = renderAboutPage(); break;
                    case 'support': pageContent = renderSupportPage(); break;
                    case 'landing':
                    default:
                        pageContent = renderLandingPage();
                }
                content = renderMainLayout(pageContent);
            }

            // Adiciona notificação se houver
            const notificationHtml = state.notification ? renderNotificationBanner(state.notification) : '';
            
            appRoot.innerHTML = notificationHtml + content;

            // Ativa os ícones do Lucide (APÓS o innerHTML ser setado)
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Atacha os event listeners
            attachAllEventListeners();

            // Renderiza os gráficos se estiver no dashboard
            if (page === 'dashboard') {
                initDashboardCharts();
            }
        }

        // Layout Principal (com Header/Footer)
        function renderMainLayout(pageContent) {
            return `
                <div class="flex flex-col min-h-screen ${state.theme === 'dark' ? 'dark' : ''} font-inter min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
                    ${renderHeader()}
                    <main class="flex-1 container mx-auto px-4 py-8">
                        ${pageContent}
                    </main>
                    ${renderFooter()}
                </div>
            `;
        }
        
        // Layout de Autenticação (centralizado)
        function renderAuthLayout(pageContent) {
            return `
                <div class="flex items-center justify-center min-h-screen bg-white dark:bg-gray-900 ${state.theme === 'dark' ? 'dark' : ''}">
                    ${pageContent}
                </div>
            `;
        }

        // Componente: Header
        function renderHeader() {
            const { user, appUser, isAdmin } = state;
            const userGreeting = appUser?.firstName || 'Usuário';
            
            const navLinks = user
                ? [
                    { name: 'Dashboard', page: 'dashboard', icon: 'home' },
                    { name: 'Perfil', page: 'profile', icon: 'user' },
                    ...(isAdmin ? [{ name: 'Admin', page: 'admin', icon: 'shield' }] : []),
                ]
                : [
                    { name: 'Sobre', page: 'about', icon: 'info' },
                    { name: 'Suporte', page: 'help-circle' },
                ];
            
            const navLinksHtml = navLinks.map(link => `
                <button data-page="${link.page}" class="nav-link flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                    <i data-lucide="${link.icon}" class="w-5 h-5"></i>
                    <span>${link.name}</span>
                </button>
            `).join('');

            const authButtonsDesktop = user
                ? `
                    <div class="flex items-center space-x-4">
                        <img 
                            src="${appUser?.photoURL || `https://placehold.co/40x40/EBF4FF/76A9FA?text=${userGreeting[0]}`}" 
                            alt="Perfil" 
                            class="w-10 h-10 rounded-full object-cover border-2 border-blue-500"
                            onerror="this.onerror=null; this.src='https://placehold.co/40x40/EBF4FF/76A9FA?text=U';"
                        />
                        <button id="logout-button" class="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                            Sair
                        </button>
                    </div>
                `
                : `
                    <div class="space-x-2">
                        <button data-page="login" class="nav-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                            <i data-lucide="log-in" class="w-4 h-4 mr-2"></i>
                            Login
                        </button>
                        <button data-page="register" class="nav-link flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                            Cadastrar
                        </button>
                    </div>
                `;

            const authButtonsMobile = user
                ? `
                    <div class="flex flex-col space-y-3">
                        <div class="flex items-center space-x-3">
                            <img 
                                src="${appUser?.photoURL || `https://placehold.co/40x40/EBF4FF/76A9FA?text=${userGreeting[0]}`}" 
                                alt="Perfil" 
                                class="w-10 h-10 rounded-full object-cover border-2 border-blue-500"
                                onerror="this.onerror=null; this.src='https://placehold.co/40x40/EBF4FF/76A9FA?text=U';"
                            />
                            <span class="font-medium">${userGreeting}</span>
                        </div>
                        <button id="logout-button-mobile" class="flex items-center justify-center px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                            Sair
                        </button>
                    </div>
                `
                : `
                    <div class="flex flex-col space-y-3">
                        <button data-page="login" class="nav-link flex items-center justify-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                            <i data-lucide="log-in" class="w-4 h-4 mr-2"></i>
                            Login
                        </button>
                        <button data-page="register" class="nav-link flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                            Cadastrar
                        </button>
                    </div>
                `;

            return `
                <header class="bg-white dark:bg-gray-800 shadow sticky top-0 z-40">
                    <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
                        <!-- Logo -->
                        <button data-page="${user ? 'dashboard' : 'landing'}" class="nav-link text-3xl font-bold text-blue-600 dark:text-blue-400 flex items-center">
                            <i data-lucide="dollar-sign" class="w-8 h-8 mr-2"></i>
                            FinControl
                        </button>

                        <!-- Links do Desktop -->
                        <div class="hidden md:flex items-center space-x-6">
                            ${navLinksHtml}
                        </div>

                        <!-- Botões de Ação (Desktop) -->
                        <div class="hidden md:flex items-center space-x-4">
                            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                                <i data-lucide="${state.theme === 'light' ? 'moon' : 'sun'}" class="w-5 h-5"></i>
                            </button>
                            ${authButtonsDesktop}
                        </div>
                        
                        <!-- Botão do Menu Mobile -->
                        <div class="md:hidden flex items-center space-x-2">
                            <button id="theme-toggle-mobile" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                                 <i data-lucide="${state.theme === 'light' ? 'moon' : 'sun'}" class="w-5 h-5"></i>
                            </button>
                            <button id="mobile-menu-button" class="text-gray-700 dark:text-gray-300">
                                <i data-lucide="menu" class="w-7 h-7"></i>
                            </button>
                        </div>
                    </nav>

                    <!-- Menu Mobile Dropdown (inicialmente oculto) -->
                    <div id="mobile-menu" class="hidden md:hidden bg-white dark:bg-gray-800 shadow-lg pb-4 px-4 space-y-4 animate-slide-down">
                        ${navLinksHtml}
                        <hr class="dark:border-gray-700"/>
                        ${authButtonsMobile}
                    </div>
                </header>
            `;
        }

        // Componente: Footer
        function renderFooter() {
            return `
                <footer class="bg-white dark:bg-gray-800 shadow-inner py-6 mt-12">
                    <div class="container mx-auto px-4 text-center text-gray-600 dark:text-gray-400">
                        <p>&copy; ${new Date().getFullYear()} FinControl. Todos os direitos reservados.</p>
                        <p>Seu assistente financeiro pessoal.</p>
                    </div>
                </footer>
            `;
        }

        // Componente: Card
        function renderCard({ header, body, footer, bodyClass = '' }) {
            return `
                <div class="w-full max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-gray-100 dark:border-gray-700/50">
                    ${header ? `<div class="p-6 md:p-8 border-b border-gray-200 dark:border-gray-700 flex flex-col items-center">${header}</div>` : ''}
                    ${body ? `<div class="p-6 md:p-8 ${bodyClass}">${body}</div>` : ''}
                    ${footer ? `<div class="p-6 md:p-8 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-center text-gray-600 dark:text-gray-400">${footer}</div>` : ''}
                </div>
            `;
        }

        // Componente: Input
        function renderInput({ id, label, type, value = '', placeholder = '', icon, disabled = false, required = false }) {
            const iconHtml = icon ? `
                <div class_="${type === 'password' ? 'cursor-pointer' : 'pointer-events-none'} absolute inset-y-0 left-0 pl-3 flex items-center" ${type === 'password' ? `id="${id}-icon"` : ''}>
                    <i data-lucide="${icon}" class="w-5 h-5 text-gray-400 dark:text-gray-500"></i>
                </div>
            ` : '';
            return `
                <div class="w-full">
                    <label for="${id}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">${label}</label>
                    <div class="relative">
                        <input 
                            type="${type}" 
                            id="${id}" 
                            name="${id}"
                            value="${value}" 
                            placeholder="${placeholder}"
                            ${disabled ? 'disabled' : ''}
                            ${required ? 'required' : ''}
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${icon ? 'pl-11' : ''} ${disabled ? 'bg-gray-200 dark:bg-gray-600 cursor-not-allowed' : ''}"
                        />
                        ${iconHtml}
                    </div>
                </div>
            `;
        }
        
        // Componente: Select
        function renderSelect({ id, label, value, options, required = false }) {
             const optionsHtml = options.map(opt => `<option value="${opt.value}" ${opt.value === value ? 'selected' : ''} ${opt.disabled ? 'disabled' : ''}>${opt.label}</option>`).join('');
            return `
                <div>
                    <label for="${id}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">${label}</label>
                    <select 
                        id="${id}" 
                        name="${id}"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        ${required ? 'required' : ''}
                    >
                        ${optionsHtml}
                    </select>
                </div>
            `;
        }

        // Componente: Loading Spinner
        function renderLoadingSpinner(fullScreen = false) {
            return `
                <div class="flex items-center justify-center ${fullScreen ? 'h-screen w-screen' : 'h-full w-full'}">
                    <div class="loader animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                </div>
            `;
        }
        
        // Componente: Botão de Loading
        function renderLoadingButton(id, text) {
            return `
                <button 
                    id="${id}"
                    type="submit" 
                    disabled
                    class="w-full bg-blue-300 text-white py-3 rounded-lg font-semibold transition-colors disabled:cursor-not-allowed flex items-center justify-center"
                >
                    <div class="loader animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-2"></div>
                    ${text}
                </button>
            `;
        }

        // Componente: Notificação
        function renderNotificationBanner({ message, type }) {
            const config = {
                success: { bg: 'bg-green-500', icon: 'check-circle' },
                error: { bg: 'bg-red-500', icon: 'alert-circle' },
                info: { bg: 'bg-blue-500', icon: 'bell' },
            }[type];

            return `
                <div id="notification-banner" class="fixed top-5 right-5 z-50 ${config.bg} text-white p-4 rounded-lg shadow-lg flex items-center animate-slide-in">
                    <i data-lucide="${config.icon}" class="w-5 h-5 mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
        }

        // --- PÁGINAS ---

        // Página: Landing
        function renderLandingPage() {
            return `
                <div class="text-center">
                    <div class="py-16 md:py-24">
                        <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white mb-6 animate-fade-in-up">
                            Tome o Controle da sua Vida Financeira
                        </h1>
                        <p class="text-lg md:text-xl text-gray-700 dark:text-gray-300 mb-10 max-w-2xl mx-auto animate-fade-in-up" style="animation-delay: 300ms">
                            FinControl é a ferramenta intuitiva que você precisava para organizar suas receitas,
                            controlar seus gastos e alcançar seus objetivos financeiros com gráficos claros e profissionais.
                        </p>
                        <button 
                            data-page="register"
                            class="nav-link px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105 animate-fade-in-up" 
                            style="animation-delay: 600ms"
                        >
                            Comece Agora (É Grátis)
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-left mt-16">
                        ${renderFeatureCard({ icon: 'bar-chart-3', color: 'text-blue-500', title: 'Gráficos Profissionais', description: 'Visualize seus dados financeiros com gráficos de barra e rosca que facilitam o entendimento.' })}
                        ${renderFeatureCard({ icon: 'credit-card', color: 'text-green-500', title: 'Gestão de Gastos', description: 'Cadastre todas as suas receitas e despesas de forma rápida e categorize seus gastos.' })}
                        ${renderFeatureCard({ icon: 'shield', color: 'text-red-500', title: 'Seguro e Confiável', description: 'Seus dados são protegidos com a tecnologia Firebase, garantindo privacidade e segurança.' })}
                    </div>
                </div>
            `;
        }

        function renderFeatureCard({ icon, color, title, description }) {
            return `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div class="mb-4"><i data-lucide="${icon}" class="w-10 h-10 ${color}"></i></div>
                    <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-white">${title}</h3>
                    <p class="text-gray-600 dark:text-gray-400">${description}</p>
                </div>
            `;
        }
        
        // Página: Login
        function renderLoginPage() {
            const header = `
                <i data-lucide="dollar-sign" class="w-10 h-10 text-blue-600 dark:text-blue-400"></i>
                <h2 class="text-3xl font-bold text-center mt-2">Login no FinControl</h2>
                <p class="text-gray-600 dark:text-gray-400 text-center">Bem-vindo de volta!</p>
            `;
            const body = `
                <form id="login-form" class="space-y-4">
                    ${renderInput({ id: 'email', type: 'email', label: 'E-mail', placeholder: 'seu@email.com', icon: 'user', required: true })}
                    ${renderInput({ id: 'password', type: 'password', label: 'Senha', placeholder: 'Sua senha', icon: 'eye', required: true })}
                    <div id="login-button-container">
                        <button 
                            type="submit" 
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition-all transform hover:scale-102 disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center"
                        >
                            Entrar
                        </button>
                    </div>
                </form>
            `;
            const footer = `
                <p>Não tem uma conta? 
                    <button data-page="register" class="nav-link text-blue-600 dark:text-blue-400 hover:underline font-medium ml-1">
                        Cadastre-se
                    </button>
                </p>
            `;
            return renderCard({ header, body, footer });
        }

        // Página: Registro
        function renderRegisterPage() {
            const header = `
                <i data-lucide="user-plus" class="w-10 h-10 text-blue-600 dark:text-blue-400"></i>
                <h2 class="text-3xl font-bold text-center mt-2">Crie sua Conta</h2>
                <p class="text-gray-600 dark:text-gray-400 text-center">Comece a organizar suas finanças.</p>
            `;
            const body = `
                <form id="register-form" class="space-y-4">
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        ${renderInput({ id: 'firstName', type: 'text', label: 'Nome', placeholder: 'Seu nome', required: true })}
                        ${renderInput({ id: 'lastName', type: 'text', label: 'Sobrenome', placeholder: 'Seu sobrenome', required: true })}
                    </div>
                    ${renderInput({ id: 'email', type: 'email', label: 'E-mail', placeholder: 'seu@email.com', required: true })}
                    ${renderInput({ id: 'phone', type: 'tel', label: 'Telefone', placeholder: '(XX) XXXXX-XXXX', required: true })}
                    ${renderInput({ id: 'password', type: 'password', label: 'Senha', placeholder: 'Mínimo 6 caracteres', required: true })}
                    ${renderInput({ id: 'confirmPassword', type: 'password', label: 'Confirmar Senha', placeholder: 'Repita a senha', required: true })}
                    
                    <div id="register-button-container">
                        <button 
                            type="submit" 
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition-all transform hover:scale-102 disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center"
                        >
                            Cadastrar
                        </button>
                    </div>
                </form>
            `;
            const footer = `
                <p>Já tem uma conta? 
                    <button data-page="login" class="nav-link text-blue-600 dark:text-blue-400 hover:underline font-medium ml-1">
                        Faça login
                    </button>
                </p>
            `;
            return renderCard({ header, body, footer });
        }

        // Página: Dashboard
        function renderDashboardPage() {
            const { appUser, transactions } = state;
            
            // Cálculos
            const summary = calculateFinancialSummary(transactions);

            return `
                <div class="space-y-8">
                    <!-- Header do Dashboard -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                                Bem-vindo, ${appUser?.firstName || 'Usuário'}!
                            </h1>
                            <p class="text-gray-600 dark:text-gray-400">Aqui está seu resumo financeiro.</p>
                        </div>
                        <button 
                            id="add-transaction-button"
                            class="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors transform hover:scale-105"
                        >
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            Adicionar Transação
                        </button>
                    </div>

                    <!-- Cards de Resumo -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${renderSummaryCard({ title: "Receita Total", amount: summary.revenue, icon: 'arrow-up-circle', color: 'text-green-500' })}
                        ${renderSummaryCard({ title: "Despesa Total", amount: summary.expense, icon: 'arrow-down-circle', color: 'text-red-500' })}
                        ${renderSummaryCard({ title: "Saldo Atual", amount: summary.balance, icon: 'dollar-sign', color: summary.balance >= 0 ? 'text-blue-500' : 'text-red-500' })}
                    </div>

                    <!-- Gráficos -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${renderChartContainer('Receita vs. Despesa (Últimos 6 Meses)', '<canvas id="monthlyChart"></canvas>')}
                        ${renderChartContainer('Despesas por Categoria', '<div class="w-full max-w-xs mx-auto"><canvas id="categoryChart"></canvas></div>')}
                    </div>

                    <!-- Lista de Transações Recentes -->
                    ${renderTransactionList(transactions.slice(0, 10))}
                </div>
                
                <!-- Modal (oculto por padrão) -->
                ${renderTransactionModal()}
            `;
        }
        
        function renderSummaryCard({ title, amount, icon, color }) {
            return `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 flex items-center space-x-4">
                    <div class="p-3 rounded-full bg-gray-100 dark:bg-gray-700">
                        <i data-lucide="${icon}" class="w-8 h-8 ${color}"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">${title}</p>
                        <p class="text-3xl font-bold ${color}">
                            ${amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                        </p>
                    </div>
                </div>
            `;
        }

        function renderChartContainer(title, chartHtml) {
            return `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">${title}</h3>
                    <div class="w-full h-full">
                        ${chartHtml}
                    </div>
                </div>
            `;
        }

        function renderTransactionList(transactions) {
            const categoryIcons = {
                'Alimentação': 'utensils', 'Transporte': 'tram-front', 'Lazer': 'gift',
                'Moradia': 'home', 'Compras': 'shopping-bag', 'Salário': 'dollar-sign',
                'Outros': 'credit-card', 'Freelance': 'briefcase', 'Investimentos': 'trending-up'
            };
            
            let itemsHtml = '';
            if (transactions.length === 0) {
                itemsHtml = '<p class="text-gray-600 dark:text-gray-400 text-center py-4">Nenhuma transação encontrada.</p>';
            } else {
                itemsHtml = transactions.map(t => {
                    const icon = categoryIcons[t.category] || 'credit-card';
                    const amount = t.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    const date = t.date.toDate ? t.date.toDate().toLocaleDateString('pt-BR') : new Date(t.date).toLocaleDateString('pt-BR');
                    const isRevenue = t.type === 'revenue';
                    
                    return `
                        <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                            <div class="flex items-center space-x-3">
                                <span class="p-2 rounded-full ${isRevenue ? 'bg-green-100 dark:bg-green-900 text-green-600' : 'bg-red-100 dark:bg-red-900 text-red-600'}">
                                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                                </span>
                                <div>
                                    <p class="font-semibold text-gray-800 dark:text-gray-200">${t.title}</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        ${date} - ${t.category}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="font-bold ${isRevenue ? 'text-green-600' : 'text-red-600'}">
                                    ${isRevenue ? '+' : '-'} ${amount}
                                </span>
                                <button 
                                    data-id="${t.id}"
                                    class="delete-transaction-button p-2 rounded-full text-gray-400 hover:bg-red-100 dark:hover:bg-red-900 dark:hover:text-red-400 hover:text-red-500 transition-colors"
                                >
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            return `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Transações Recentes</h3>
                    <div class="space-y-4">
                        ${itemsHtml}
                    </div>
                </div>
            `;
        }

        // Página: Modal de Transação
        function renderTransactionModal() {
            const expenseCategories = ['Alimentação', 'Transporte', 'Lazer', 'Moradia', 'Compras', 'Outros'];
            const revenueCategories = ['Salário', 'Freelance', 'Investimentos', 'Outros'];
            
            const expenseOptions = expenseCategories.map(c => ({ label: c, value: c }));
            
            // O modal é renderizado, mas oculto
            return `
                <div id="transaction-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
                     data-closable="true">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md m-4 animate-scale-in"
                         data-closable="false">
                        <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Nova Transação</h3>
                            <button id="modal-close-button" class="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <form id="transaction-form" class="p-6 space-y-4">
                            <!-- Tipo de Transação -->
                            <div class="grid grid-cols-2 gap-2 rounded-lg bg-gray-100 dark:bg-gray-700 p-1">
                                <button 
                                    type="button" 
                                    id="modal-type-expense"
                                    class="py-2 rounded-md font-medium transition-colors bg-red-500 text-white shadow"
                                >
                                    Despesa
                                </button>
                                <button 
                                    type="button" 
                                    id="modal-type-revenue"
                                    class="py-2 rounded-md font-medium transition-colors text-gray-700 dark:text-gray-300"
                                >
                                    Receita
                                </button>
                            </div>

                            ${renderInput({ id: 'modal-title', label: 'Título', type: 'text', placeholder: 'Ex: Almoço', required: true })}
                            ${renderInput({ id: 'modal-amount', label: 'Valor (R$)', type: 'number', placeholder: '0.00', required: true })}
                            ${renderInput({ id: 'modal-date', label: 'Data', type: 'date', value: new Date().toISOString().split('T')[0], required: true })}
                            
                            <div id="modal-category-select-container">
                                ${renderSelect({ id: 'modal-category', label: 'Categoria', value: '', options: [{label: 'Selecione uma categoria', value: '', disabled: true}, ...expenseOptions], required: true })}
                            </div>

                            <button 
                                type="submit" 
                                id="modal-submit-button"
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition-all transform hover:scale-102"
                            >
                                Adicionar Transação
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        // Página: Perfil
        function renderProfilePage() {
            const { appUser } = state;
            if (!appUser) return renderLoadingSpinner();
            
            const photoURL = appUser.photoURL || '';
            const firstName = appUser.firstName || '';
            
            const header = `
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Meu Perfil</h1>
            `;
            const body = `
                <form id="profile-form" class="space-y-6">
                    <div class="flex justify-center mb-6">
                        <img 
                            id="profile-image-preview"
                            src="${photoURL || `https://placehold.co/128x128/EBF4FF/76A9FA?text=${firstName[0] || 'U'}`}" 
                            alt="Foto do Perfil" 
                            class="w-32 h-32 rounded-full object-cover border-4 border-blue-500 shadow-lg"
                            onerror="this.onerror=null; this.src='https://placehold.co/128x128/EBF4FF/76A9FA?text=U';"
                        />
                    </div>
                    
                    ${renderInput({ id: 'profile-photoURL', type: 'text', label: 'URL da Foto do Perfil', value: photoURL, placeholder: 'https://sua-imagem.com/foto.png' })}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${renderInput({ id: 'profile-firstName', type: 'text', label: 'Nome', value: firstName, required: true })}
                        ${renderInput({ id: 'profile-lastName', type: 'text', label: 'Sobrenome', value: appUser.lastName || '', required: true })}
                    </div>
                    
                    ${renderInput({ id: 'profile-email', type: 'email', label: 'E-mail', value: appUser.email, disabled: true })}
                    ${renderInput({ id: 'profile-phone', type: 'tel', label: 'Telefone', value: appUser.phone || '', required: true })}

                    <div id="profile-button-container">
                        <button 
                            type="submit"
                            class="w-full flex items-center justify-center bg-blue-600 text-white py-3 rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition-all transform hover:scale-102 disabled:bg-blue-300"
                        >
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                            Salvar Alterações
                        </button>
                    </div>
                </form>
            `;
            return `
                <div class="max-w-2xl mx-auto">
                    ${renderCard({ header, body })}
                </div>
            `;
        }
        
        // Página: Admin
        function renderAdminPage() {
            if (!state.isAdmin) {
                return `
                    <div class="text-center">
                        <i data-lucide="alert-circle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
                        <h1 class="text-3xl font-bold text-red-500">Acesso Negado</h1>
                        <p class="text-lg text-gray-700 dark:text-gray-300 mt-2">
                            Você não tem permissão para acessar esta página.
                        </p>
                    </div>
                `;
            }

            const { userList, appUser } = state;
            const rows = userList.map(u => {
                const isCurrentUser = u.id === appUser.uid;
                return `
                    <tr key="${u.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${u.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${u.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                u.isAdmin 
                                ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' 
                                : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'
                            }">
                                ${u.isAdmin ? 'Admin' : 'Usuário'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button 
                                data-id="${u.id}"
                                data-is-admin="${u.isAdmin}"
                                class="toggle-admin-button px-3 py-1 rounded-md text-white transition-colors ${
                                    u.isAdmin
                                    ? 'bg-yellow-500 hover:bg-yellow-600'
                                    : 'bg-green-500 hover:bg-green-600'
                                } ${isCurrentUser ? 'disabled:bg-gray-400 disabled:cursor-not-allowed' : ''}"
                                ${isCurrentUser ? 'disabled' : ''}
                            >
                                ${u.isAdmin ? 'Rebaixar' : 'Promover'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const body = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nome</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ação</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
            
            return `
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Gerenciamento de Usuários</h1>
                    ${renderCard({ body, bodyClass: 'p-0' })}
                </div>
            `;
        }

        // Página: Sobre
        function renderAboutPage() {
            const body = `
                <div class="space-y-4 text-gray-700 dark:text-gray-300 leading-relaxed">
                    <p>
                        O FinControl nasceu da necessidade de uma ferramenta simples, intuitiva e poderosa
                        para o gerenciamento financeiro pessoal. Em um mundo onde o controle das finanças
                        é essencial para a tranquilidade e a realização de sonhos, nossa plataforma oferece
                        a clareza que você precisa.
                    </p>
                    <p>
                        Nossa missão é desmistificar o controle financeiro. Com gráficos profissionais,
                        cadastro rápido de transações e um dashboard completo, queremos que você
                        entenda para onde seu dinheiro está indo e tome decisões mais inteligentes
                        sobre como usá-lo.
                    </p>
                    <p>
                        Este projeto foi construído utilizando as tecnologias mais modernas, incluindo
                        HTML, Tailwind CSS, JavaScript e Firebase, para garantir uma experiência rápida, segura e
                        agradável em qualquer dispositivo.
                    </p>
                </div>
            `;
            return `
                <div class="max-w-3xl mx-auto text-lg">
                    <h1 class="text-4xl font-bold mb-6 text-gray-900 dark:text-white">Sobre o FinControl</h1>
                    ${renderCard({ body })}
                </div>
            `;
        }

        // Página: Suporte
        function renderSupportPage() {
            const body = `
                <div class="space-y-4 text-gray-700 dark:text-gray-300">
                    <p class="text-lg">
                        Encontrou algum problema ou tem alguma sugestão? Estamos aqui para ajudar!
                    </p>
                    <p>
                        Por favor, entre em contato conosco através do nosso e-mail de suporte. Nossa equipe
                        fará o possível para responder o mais rápido possível.
                    </p>
                    <div class="text-center my-6">
                        <a 
                            href="mailto:suporte@fincontrol.com" 
                            class="inline-block px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
                        >
                            suporte@fincontrol.com
                        </a>
                    </div>
                    <p class="text-center text-gray-600 dark:text-gray-400">
                        Horário de atendimento: Segunda a Sexta, das 9h às 18h.
                    </p>
                </div>
            `;
            return `
                 <div class="max-w-3xl mx-auto">
                    <h1 class="text-4xl font-bold mb-6 text-gray-900 dark:text-white">Suporte</h1>
                    ${renderCard({ body })}
                </div>
            `;
        }

        // --- FUNÇÕES DE LÓGICA (HANDLERS) ---

        // Navegação
        function navigateTo(page) {
            state.currentPage = page;
            renderApp();
        }

        // Tema
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', state.theme);
            renderApp();
        }
        
        // Notificação
        function showNotification(message, type = 'info', duration = 3000) {
            state.notification = { message, type };
            renderApp();
            setTimeout(() => {
                state.notification = null;
                document.getElementById('notification-banner')?.remove();
            }, duration);
        }

        // Autenticação
        async function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const email = form.email.value;
            const password = form.password.value;
            
            if (!email || !password) {
                return showNotification('Por favor, preencha todos os campos.', 'error');
            }
            
            setLoadingButton('login-button-container', 'Entrando...');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged cuidará do resto
                showNotification('Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro no login:", error);
                let message = 'Ocorreu um erro ao fazer login.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = 'E-mail ou senha inválidos.';
                }
                showNotification(message, 'error');
                renderApp(); // Restaura o botão de login
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = e.target;
            const { firstName, lastName, email, phone, password, confirmPassword } = form;

            if (!firstName.value || !lastName.value || !email.value || !phone.value || !password.value || !confirmPassword.value) {
                return showNotification('Por favor, preencha todos os campos.', 'error');
            }
            if (password.value !== confirmPassword.value) {
                return showNotification('As senhas não coincidem.', 'error');
            }
            if (password.value.length < 6) {
                return showNotification('A senha deve ter pelo menos 6 caracteres.', 'error');
            }
            
            setLoadingButton('register-button-container', 'Cadastrando...');

            try {
                // 1. Criar usuário no Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email.value, password.value);
                const user = userCredential.user;

                // 2. Criar perfil do usuário no Firestore (coleção privada)
                const userProfileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/data`);
                await setDoc(userProfileRef, {
                    uid: user.uid,
                    firstName: firstName.value,
                    lastName: lastName.value,
                    email: email.value,
                    phone: phone.value,
                    photoURL: '',
                    isAdmin: false,
                    createdAt: serverTimestamp()
                });

                // 3. Criar entrada na lista pública de usuários (para o Admin)
                const userListRef = doc(db, `/artifacts/${appId}/public/data/userList`, user.uid);
                await setDoc(userListRef, {
                    uid: user.uid,
                    name: `${firstName.value} ${lastName.value}`,
                    email: email.value,
                    isAdmin: false,
                    joinedAt: serverTimestamp()
                });

                // onAuthStateChanged cuidará do resto
                showNotification('Cadastro realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro no cadastro:", error);
                let message = 'Ocorreu um erro ao cadastrar.';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Este e-mail já está em uso.';
                }
                showNotification(message, 'error');
                renderApp(); // Restaura o botão
            }
        }
        
        async function handleLogout() {
            await signOut(auth);
            // onAuthStateChanged cuidará do resto
            showNotification('Você saiu da sua conta.', 'info');
        }

        // Perfil
        async function handleUpdateProfile(e) {
            e.preventDefault();
            const form = e.target;
            const { 'profile-firstName': firstName, 'profile-lastName': lastName, 'profile-phone': phone, 'profile-photoURL': photoURL } = form;
            
            const profileData = {
                firstName: firstName.value,
                lastName: lastName.value,
                phone: phone.value,
                photoURL: photoURL.value,
            };

            setLoadingButton('profile-button-container', 'Salvando...', 'save');

            try {
                // 1. Atualizar perfil privado
                const profileRef = doc(db, `/artifacts/${appId}/users/${state.userId}/profile/data`);
                await updateDoc(profileRef, profileData);
                
                // 2. Atualizar lista pública (apenas nome)
                const listRef = doc(db, `/artifacts/${appId}/public/data/userList`, state.userId);
                await updateDoc(listRef, {
                    name: `${firstName.value} ${lastName.value}`
                });

                // 3. Atualizar estado local (para UI imediata)
                state.appUser = { ...state.appUser, ...profileData };
                
                showNotification('Perfil atualizado com sucesso!', 'success');
                renderApp(); // Re-renderiza para restaurar o botão e mostrar dados
                
            } catch (error) {
                console.error("Erro ao atualizar perfil:", error);
                showNotification('Erro ao atualizar perfil.', 'error');
                renderApp();
            }
        }
        
        // Transações
        async function handleAddTransaction(e) {
            e.preventDefault();
            const form = e.target;
            const { 'modal-title': title, 'modal-amount': amount, 'modal-date': date, 'modal-category': category } = form;
            const type = document.getElementById('modal-type-expense').classList.contains('bg-red-500') ? 'expense' : 'revenue';
            
            if (!title.value || !amount.value || !date.value || !category.value) {
                return showNotification('Por favor, preencha todos os campos.', 'error');
            }

            try {
                const collectionPath = `/artifacts/${appId}/users/${state.userId}/transactions`;
                await addDoc(collection(db, collectionPath), {
                    title: title.value,
                    amount: parseFloat(amount.value),
                    type: type,
                    date: new Date(date.value), // Salva como objeto Date
                    category: category.value,
                    createdAt: serverTimestamp()
                });
                showNotification('Transação adicionada!', 'success');
                toggleModal(false); // Fecha o modal
            } catch (error) {
                console.error("Erro ao adicionar transação:", error);
                showNotification('Erro ao salvar transação.', 'error');
            }
        }
        
        async function handleDeleteTransaction(id) {
            const docRef = doc(db, `/artifacts/${appId}/users/${state.userId}/transactions`, id);
            try {
                await deleteDoc(docRef);
                showNotification('Transação excluída!', 'success');
            } catch (error) {
                console.error("Erro ao excluir transação:", error);
                showNotification('Erro ao excluir transação.', 'error');
            }
        }

        // Admin
        async function handleToggleAdmin(id, currentIsAdmin) {
            const newAdminStatus = !currentIsAdmin;
            
            if (id === state.appUser.uid) {
                return showNotification('Você não pode remover seu próprio status de administrador.', 'error');
            }

            try {
                // 1. Atualiza lista pública
                const listRef = doc(db, `/artifacts/${appId}/public/data/userList`, id);
                await updateDoc(listRef, { isAdmin: newAdminStatus });
                
                // 2. Atualiza perfil privado
                const profileRef = doc(db, `/artifacts/${appId}/users/${id}/profile/data`);
                await updateDoc(profileRef, { isAdmin: newAdminStatus });
                
                showNotification(`Status do usuário atualizado!`, 'success');
            } catch (error) {
                console.error("Erro ao atualizar status do admin:", error);
                showNotification('Erro ao atualizar status do usuário.', 'error');
            }
        }

        // --- LÓGICA DE CÁLCULO (Dashboard) ---
        function calculateFinancialSummary(transactions) {
            const revenue = transactions
                .filter(t => t.type === 'revenue')
                .reduce((acc, t) => acc + t.amount, 0);
            const expense = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => acc + t.amount, 0);
            const balance = revenue - expense;
            return { revenue, expense, balance };
        }
        
        function getCategoryData(transactions) {
            const expenses = transactions.filter(t => t.type === 'expense');
            const grouped = expenses.reduce((acc, t) => {
                const category = t.category || 'Outros';
                acc[category] = (acc[category] || 0) + t.amount;
                return acc;
            }, {});
            
            const labels = Object.keys(grouped);
            const data = Object.values(grouped);
            return { labels, data };
        }
        
        function getMonthlyData(transactions) {
            const months = {};
            const today = new Date();
            
            // Inicializa os últimos 6 meses
            let labels = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthName = d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
                labels.push(monthName);
                months[monthName] = { Receita: 0, Despesa: 0 };
            }
            
            transactions.forEach(t => {
                const tDate = t.date.toDate ? t.date.toDate() : new Date(t.date);
                const monthName = tDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });

                if (months[monthName]) {
                    if (t.type === 'revenue') {
                        months[monthName].Receita += t.amount;
                    } else {
                        months[monthName].Despesa += t.amount;
                    }
                }
            });

            const revenues = labels.map(l => months[l].Receita);
            const expenses = labels.map(l => months[l].Despesa);
            
            return { labels, revenues, expenses };
        }

        // --- INICIALIZAÇÃO DOS GRÁFICOS (Chart.js) ---
        function initDashboardCharts() {
            // Espera o Chart.js estar disponível
            if (typeof Chart === 'undefined') {
                setTimeout(initDashboardCharts, 100); // Tenta novamente em 100ms
                return;
            }

            const { transactions, theme, chartInstances } = state;
            const isDark = theme === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDark ? '#d1d5db' : '#374151';

            // Destrói gráficos antigos para evitar flickering
            chartInstances.monthlyChart?.destroy();
            chartInstances.categoryChart?.destroy();

            // Gráfico 1: Receita vs. Despesa (Mensal)
            const monthlyCtx = document.getElementById('monthlyChart')?.getContext('2d');
            if (monthlyCtx) {
                const { labels, revenues, expenses } = getMonthlyData(transactions);
                chartInstances.monthlyChart = new Chart(monthlyCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Receita',
                                data: revenues,
                                backgroundColor: '#22c55e',
                                borderRadius: 4,
                            },
                            {
                                label: 'Despesa',
                                data: expenses,
                                backgroundColor: '#ef4444',
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: labelColor } } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: labelColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: labelColor },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            // Gráfico 2: Despesas por Categoria (Rosca)
            const categoryCtx = document.getElementById('categoryChart')?.getContext('2d');
            if (categoryCtx) {
                const { labels, data } = getCategoryData(transactions);
                const PIE_COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6'];
                chartInstances.categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Despesas',
                            data: data,
                            backgroundColor: PIE_COLORS,
                            borderColor: isDark ? '#1f2937' : '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: labelColor }
                            }
                        }
                    }
                });
            }
        }


        // --- EVENT LISTENERS ---
        // Função central para atachar TODOS os event listeners
        function attachAllEventListeners() {
            // Navegação
            document.querySelectorAll('.nav-link').forEach(el => {
                el.addEventListener('click', () => navigateTo(el.dataset.page));
            });

            // Tema
            document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
            document.getElementById('theme-toggle-mobile')?.addEventListener('click', toggleTheme);

            // Menu Mobile
            document.getElementById('mobile-menu-button')?.addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
                // Troca o ícone
                const icon = document.getElementById('mobile-menu-button').querySelector('i');
                icon.setAttribute('data-lucide', icon.getAttribute('data-lucide') === 'menu' ? 'x' : 'menu');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });

            // Logout
            document.getElementById('logout-button')?.addEventListener('click', handleLogout);
            document.getElementById('logout-button-mobile')?.addEventListener('click', handleLogout);
            
            // Formulários
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);
            document.getElementById('profile-form')?.addEventListener('submit', handleUpdateProfile);
            document.getElementById('transaction-form')?.addEventListener('submit', handleAddTransaction);

            // Toggle Senha
            const passwordInput = document.getElementById('password');
            const passwordIcon = document.getElementById('password-icon');
            if(passwordInput && passwordIcon) {
                passwordIcon.addEventListener('click', () => {
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    passwordIcon.innerHTML = `<i data-lucide="${isPassword ? 'eye-off' : 'eye'}" class="w-5 h-5 text-gray-400 dark:text-gray-500"></i>`;
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });
            }
            
            // Preview Imagem Perfil
            document.getElementById('profile-photoURL')?.addEventListener('input', (e) => {
                const preview = document.getElementById('profile-image-preview');
                if (preview) {
                    preview.src = e.target.value || `https://placehold.co/128x128/EBF4FF/76A9FA?text=${state.appUser?.firstName[0] || 'U'}`;
                }
            });

            // Lógica do Modal de Transação
            document.getElementById('add-transaction-button')?.addEventListener('click', () => toggleModal(true));
            document.getElementById('modal-close-button')?.addEventListener('click', () => toggleModal(false));
            document.getElementById('transaction-modal')?.addEventListener('click', (e) => {
                if (e.target.dataset.closable === 'true') toggleModal(false);
            });
            
            // Botões do Tipo de Transação (Receita/Despesa)
            document.getElementById('modal-type-expense')?.addEventListener('click', () => updateModalType('expense'));
            document.getElementById('modal-type-revenue')?.addEventListener('click', () => updateModalType('revenue'));

            // Botões de Excluir Transação (com confirmação)
            document.querySelectorAll('.delete-transaction-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const icon = e.currentTarget.querySelector('i');
                    
                    if (e.currentTarget.dataset.confirm === 'true') {
                        // Excluir de verdade
                        handleDeleteTransaction(id);
                    } else {
                        // Pedir confirmação
                        showNotification('Clique novamente na lixeira para confirmar.', 'info');
                        e.currentTarget.dataset.confirm = 'true';
                        e.currentTarget.classList.add('bg-red-500', 'text-white');
                        e.currentTarget.classList.remove('text-gray-400');
                        icon.setAttribute('data-lucide', 'check');
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                        
                        // Resetar após 3s
                        setTimeout(() => {
                            // Verifica se o botão ainda existe antes de modificar
                            const currentBtn = document.querySelector(`button[data-id="${id}"].delete-transaction-button`);
                            if (currentBtn && currentBtn.dataset.confirm === 'true') {
                                currentBtn.dataset.confirm = 'false';
                                currentBtn.classList.remove('bg-red-500', 'text-white');
                                currentBtn.classList.add('text-gray-400');
                                const currentIcon = currentBtn.querySelector('i');
                                if(currentIcon) currentIcon.setAttribute('data-lucide', 'trash-2');
                                if (typeof lucide !== 'undefined') {
                                    lucide.createIcons();
                                }
                            }
                        }, 3000);
                    }
                });
            });
            
            // Botões de Admin
            document.querySelectorAll('.toggle-admin-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const isAdmin = e.currentTarget.dataset.isAdmin === 'true';
                    e.currentTarget.disabled = true;
                    e.currentTarget.textContent = '...';
                    handleToggleAdmin(id, isAdmin);
                });
            });
        }
        
        // --- FUNÇÕES AUXILIARES ---
        
        function setLoadingButton(containerId, text, icon = 'loader') {
            const container = document.getElementById(containerId);
            if (container) {
                const iconHtml = icon === 'loader' 
                    ? `<div class="loader animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-2"></div>`
                    : `<i data-lucide="${icon}" class="w-5 h-5 mr-2"></i>`;
                
                container.innerHTML = `
                    <button type="submit" disabled class="w-full bg-blue-300 text-white py-3 rounded-lg font-semibold transition-colors disabled:cursor-not-allowed flex items-center justify-center">
                        ${iconHtml}
                        ${text}
                    </button>
                `;
                if(icon !== 'loader' && typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }
        
        function toggleModal(show) {
            document.getElementById('transaction-modal')?.classList.toggle('hidden', !show);
            if(show) {
                // Reseta o form ao abrir
                document.getElementById('transaction-form')?.reset();
                document.getElementById('modal-date').value = new Date().toISOString().split('T')[0];
                updateModalType('expense'); // Reseta para 'despesa'
            }
        }
        
        function updateModalType(type) {
            const expenseBtn = document.getElementById('modal-type-expense');
            const revenueBtn = document.getElementById('modal-type-revenue');
            const container = document.getElementById('modal-category-select-container');
            
            const expenseCategories = ['Alimentação', 'Transporte', 'Lazer', 'Moradia', 'Compras', 'Outros'];
            const revenueCategories = ['Salário', 'Freelance', 'Investimentos', 'Outros'];

            const options = (type === 'expense' ? expenseCategories : revenueCategories)
                .map(c => ({ label: c, value: c }));
            
            // Adiciona opção padrão
            options.unshift({ label: 'Selecione uma categoria', value: '', disabled: true });
            
            container.innerHTML = renderSelect({ 
                id: 'modal-category', 
                label: 'Categoria', 
                value: '', 
                options: options, 
                required: true 
            });

            // Atualiza estilo dos botões
            if(expenseBtn && revenueBtn) {
                if (type === 'expense') {
                    expenseBtn.className = 'py-2 rounded-md font-medium transition-colors bg-red-500 text-white shadow';
                    revenueBtn.className = 'py-2 rounded-md font-medium transition-colors text-gray-700 dark:text-gray-300';
                } else {
                    expenseBtn.className = 'py-2 rounded-md font-medium transition-colors text-gray-700 dark:text-gray-300';
                    revenueBtn.className = 'py-2 rounded-md font-medium transition-colors bg-green-500 text-white shadow';
                }
            }
        }

        // --- INICIALIZAÇÃO E LISTENERS DO FIREBASE ---

        // Gerencia os listeners onSnapshot
        function attachDataListeners(userId, isAdmin) {
            // Limpa listeners antigos
            detachDataListeners();
            
            // 1. Listener de Transações (privado)
            const transColPath = `/artifacts/${appId}/users/${userId}/transactions`;
            const qTrans = query(collection(db, transColPath));
            state.listeners.transactions = onSnapshot(qTrans, (snapshot) => {
                const trans = [];
                snapshot.forEach((doc) => trans.push({ id: doc.id, ...doc.data() }));
                // Ordena localmente
                trans.sort((a, b) => (b.date.toDate ? b.date.toDate() : new Date(b.date)) - (a.date.toDate ? a.date.toDate() : new Date(a.date)));
                
                state.transactions = trans;
                if (state.currentPage === 'dashboard') {
                    renderApp(); // Re-renderiza o dashboard com novos dados
                }
            }, (error) => console.error("Erro no listener de transações:", error));

            // 2. Listener da Lista de Usuários (público, apenas para admins)
            if (isAdmin) {
                const userListColPath = `/artifacts/${appId}/public/data/userList`;
                const qUsers = query(collection(db, userListColPath));
                state.listeners.userList = onSnapshot(qUsers, (snapshot) => {
                    const users = [];
                    snapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));
                    
                    state.userList = users;
                    if (state.currentPage === 'admin') {
                        renderApp(); // Re-renderiza o admin com novos dados
                    }
                }, (error) => console.error("Erro no listener de usuários:", error));
            }
        }
        
        function detachDataListeners() {
            state.listeners.transactions?.();
            state.listeners.userList?.();
            state.listeners.transactions = null;
            state.listeners.userList = null;
        }

        // Listener principal de Autenticação
        onAuthStateChanged(auth, async (firebaseUser) => {
            if (firebaseUser) {
                // Usuário logado
                const userProfileRef = doc(db, `/artifacts/${appId}/users/${firebaseUser.uid}/profile/data`);
                const userProfileSnap = await getDoc(userProfileRef);
                
                let appUserData;
                if (userProfileSnap.exists()) {
                    appUserData = userProfileSnap.data();
                } else {
                    // Fallback se o perfil não existir (raro)
                    appUserData = {
                        uid: firebaseUser.uid,
                        email: firebaseUser.email,
                        firstName: 'Usuário',
                        lastName: '',
                        phone: '',
                        photoURL: '',
                        isAdmin: false,
                    };
                    // Tenta criar o documento que faltava
                    try { await setDoc(userProfileRef, { ...appUserData, createdAt: serverTimestamp() }); }
                    catch(e) { console.error("Falha ao criar perfil de fallback:", e); }
                }

                state = { ...state,
                    user: firebaseUser,
                    appUser: appUserData,
                    userId: firebaseUser.uid,
                    isAuthReady: true,
                    currentPage: 'dashboard'
                };
                
                // Atacha os listeners de dados
                attachDataListeners(firebaseUser.uid, appUserData.isAdmin);

            } else {
                // Usuário deslogado
                detachDataListeners(); // Limpa listeners!
                state = { ...state,
                    user: null,
                    appUser: null,
                    userId: null,
                    isAuthReady: true,
                    currentPage: 'landing',
                    transactions: [],
                    userList: []
                };
            }
            renderApp(); // Renderiza a página (dashboard ou landing)
        });
        
        // Tenta o login inicial (silencioso)
        async function attemptInitialLogin() {
            if (initialAuthToken && !auth.currentUser) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Erro no login com Custom Token:", error);
                    if (auth.currentUser === null) {
                        await signInAnonymously(auth).catch(e => console.error("Falha no login anônimo:", e));
                    }
                }
            } else if (!auth.currentUser) {
                 // Autenticação anônima se nenhum token for fornecido
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Falha no login anônimo:", error);
                    state.isAuthReady = true;
                    renderApp();
                }
            }
            // onAuthStateChanged cuidará da renderização assim que o estado de auth for resolvido
        }

        // --- INÍCIO DA APLICAÇÃO ---
        renderApp(); // Renderiza o loading inicial
        attemptInitialLogin(); // Inicia o processo de autenticação

    </script>
</body>
</html>