import React, { useState, useEffect, useMemo, useCallback, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  signOut,
  signInWithCustomToken,
  signInAnonymously
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  addDoc, 
  collection, 
  onSnapshot, 
  query, 
  deleteDoc, 
  updateDoc,
  serverTimestamp,
  getDoc
} from 'firebase/firestore';
import { 
  BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer 
} from 'recharts';
import { 
  AlertCircle, ArrowDownCircle, ArrowUpCircle, BarChart3, Bell, CheckCircle, 
  ChevronDown, DollarSign, Edit, Eye, EyeOff, Home, LogIn, LogOut, 
  Menu, PieChart as PieChartIcon, Plus, Save, Settings, Shield, Sun, Moon,
  Trash2, User, UserPlus, Users, X, CreditCard, ShoppingBag, Gift, Coffee, Utensils, Zap
} from 'lucide-react';

// --- CONFIGURAÇÃO DO FIREBASE ---
// Estas variáveis serão injetadas pelo ambiente.
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Inicializa o Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// setLogLevel('Debug'); // Habilite para logs detalhados do Firestore

// --- CONTEXTO DE AUTENTICAÇÃO ---
// Para gerenciar o estado do usuário e navegação
const AppContext = createContext();

const AppProvider = ({ children }) => {
  const [currentPage, setCurrentPage] = useState('loading'); // loading, landing, login, register, dashboard, profile, admin, about, support
  const [user, setUser] = useState(null); // Usuário do Firebase Auth
  const [appUser, setAppUser] = useState(null); // Dados do usuário do Firestore (perfil)
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [notification, setNotification] = useState(null); // { type, message }
  const [theme, setTheme] = useState('light'); // light | dark

  // Efeito para login inicial e escuta de autenticação
  useEffect(() => {
    const unsubscribeAuth = onAuthStateChanged(auth, async (firebaseUser) => {
      if (firebaseUser) {
        // Usuário está logado
        setUser(firebaseUser);
        setUserId(firebaseUser.uid);
        
        // Buscar dados do perfil no Firestore
        const userProfileRef = doc(db, `/artifacts/${appId}/users/${firebaseUser.uid}/profile/data`);
        const userProfileSnap = await getDoc(userProfileRef);
        
        if (userProfileSnap.exists()) {
          setAppUser(userProfileSnap.data());
        } else {
          // Caso raro: usuário autenticado sem perfil no DB.
          // Isso pode acontecer se o cadastro falhar no meio.
          // Vamos forçar a criação de um perfil básico.
          const basicProfile = {
            uid: firebaseUser.uid,
            email: firebaseUser.email,
            firstName: 'Usuário',
            lastName: '',
            phone: '',
            photoURL: '',
            isAdmin: false,
            createdAt: serverTimestamp(),
          };
          await setDoc(userProfileRef, basicProfile);
          setAppUser(basicProfile);
        }

        setCurrentPage('dashboard'); // Redireciona para o dashboard
      } else {
        // Usuário está deslogado
        setUser(null);
        setUserId(null);
        setAppUser(null);
        setCurrentPage('landing'); // Redireciona para a landing page
      }
      setIsAuthReady(true);
    });
    
    // Tenta fazer login com o token inicial (se fornecido)
    const attemptInitialLogin = async () => {
      if (initialAuthToken && !auth.currentUser) {
        try {
          await signInWithCustomToken(auth, initialAuthToken);
        } catch (error) {
          console.error("Erro no login com Custom Token:", error);
          if (auth.currentUser === null) {
            await signInAnonymously(auth); // Fallback para anônimo se o token falhar
          }
        }
      } else if (!auth.currentUser) {
         // Não faz nada, deixa o onAuthStateChanged tratar (usuário deslogado)
      }
    };

    attemptInitialLogin();
    
    // Limpa o listener ao desmontar
    return () => unsubscribeAuth();
  }, []);

  // Função de navegação
  const navigateTo = (page) => {
    setCurrentPage(page);
  };

  // Função para mostrar notificações
  const showNotification = (message, type = 'info', duration = 3000) => {
    setNotification({ message, type });
    setTimeout(() => {
      setNotification(null);
    }, duration);
  };

  // Função para trocar o tema
  const toggleTheme = () => {
    setTheme(prevTheme => (prevTheme === 'light' ? 'dark' : 'light'));
  };
  
  useEffect(() => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [theme]);

  // Se a autenticação ainda não está pronta, mostra um loader
  if (!isAuthReady) {
    return <LoadingSpinner fullScreen={true} />;
  }

  return (
    <AppContext.Provider value={{ 
      user, 
      appUser, 
      userId, 
      currentPage, 
      navigateTo, 
      showNotification, 
      isAdmin: appUser?.isAdmin || false,
      theme,
      toggleTheme 
    }}>
      <div className={`${theme} font-inter`}>
        <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
          {notification && <NotificationBanner message={notification.message} type={notification.type} />}
          <Router />
        </div>
      </div>
    </AppContext.Provider>
  );
};

// --- ROTEADOR PRINCIPAL ---
const Router = () => {
  const { currentPage, user } = useContext(AppContext);

  // Layout principal com Header (exceto em login/register)
  const MainLayout = ({ children }) => (
    <div className="flex flex-col min-h-screen">
      <Header />
      <main className="flex-1 container mx-auto px-4 py-8">
        {children}
      </main>
      <Footer />
    </div>
  );

  // Layout focado para Autenticação
  const AuthLayout = ({ children }) => (
    <div className="flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900">
      {children}
    </div>
  );

  switch (currentPage) {
    case 'login':
      return <AuthLayout><LoginPage /></AuthLayout>;
    case 'register':
      return <AuthLayout><RegisterPage /></AuthLayout>;
    case 'dashboard':
      return <MainLayout><DashboardPage /></MainLayout>;
    case 'profile':
      return <MainLayout><ProfilePage /></MainLayout>;
    case 'admin':
      return <MainLayout><AdminPage /></MainLayout>;
    case 'about':
      return <MainLayout><AboutPage /></MainLayout>;
    case 'support':
      return <MainLayout><SupportPage /></MainLayout>;
    case 'landing':
      return <MainLayout><LandingPage /></MainLayout>;
    case 'loading':
    default:
      return <LoadingSpinner fullScreen={true} />;
  }
};

// --- COMPONENTES DE UI ---

const LoadingSpinner = ({ fullScreen = false }) => (
  <div className={`flex items-center justify-center ${fullScreen ? 'h-screen w-screen' : 'h-full w-full'}`}>
    <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
  </div>
);

const NotificationBanner = ({ message, type }) => {
  const bgColor = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    info: 'bg-blue-500',
  }[type];

  const Icon = {
    success: CheckCircle,
    error: AlertCircle,
    info: Bell,
  }[type];

  return (
    <div className={`fixed top-5 right-5 z-50 ${bgColor} text-white p-4 rounded-lg shadow-lg flex items-center animate-slide-in`}>
      <Icon className="mr-3" />
      <span>{message}</span>
    </div>
  );
};

const Header = () => {
  const { user, appUser, navigateTo, isAdmin, theme, toggleTheme } = useContext(AppContext);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  const handleLogout = async () => {
    await signOut(auth);
    navigateTo('landing');
  };
  
  const navLinks = user 
    ? [
        { name: 'Dashboard', page: 'dashboard', icon: Home },
        { name: 'Perfil', page: 'profile', icon: User },
        ...(isAdmin ? [{ name: 'Admin', page: 'admin', icon: Shield }] : []),
      ]
    : [
        { name: 'Sobre', page: 'about', icon: Users },
        { name: 'Suporte', page: 'support', icon: AlertCircle },
      ];

  const NavLinkItem = ({ name, page, icon: Icon }) => (
    <button 
      onClick={() => {
        navigateTo(page);
        setMobileMenuOpen(false);
      }} 
      className="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
    >
      <Icon size={20} />
      <span>{name}</span>
    </button>
  );

  return (
    <header className="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
      <nav className="container mx-auto px-4 py-4 flex justify-between items-center">
        {/* Logo */}
        <button onClick={() => navigateTo(user ? 'dashboard' : 'landing')} className="text-3xl font-bold text-blue-600 dark:text-blue-400 flex items-center">
          <DollarSign size={32} className="mr-2"/>
          FinControl
        </button>

        {/* Links do Desktop */}
        <div className="hidden md:flex items-center space-x-6">
          {navLinks.map(link => <NavLinkItem key={link.page} {...link} />)}
        </div>

        {/* Botões de Ação (Desktop) */}
        <div className="hidden md:flex items-center space-x-4">
          <button onClick={toggleTheme} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
            {theme === 'light' ? <Moon size={20} /> : <Sun size={20} />}
          </button>
          {user ? (
            <div className="flex items-center space-x-4">
              <img 
                src={appUser?.photoURL || `https://placehold.co/40x40/EBF4FF/76A9FA?text=${appUser?.firstName?.[0] || 'U'}`} 
                alt="Perfil" 
                className="w-10 h-10 rounded-full object-cover border-2 border-blue-500"
              />
              <button 
                onClick={handleLogout} 
                className="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors"
              >
                <LogOut size={18} className="mr-2" />
                Sair
              </button>
            </div>
          ) : (
            <div className="space-x-2">
              <button 
                onClick={() => navigateTo('login')}
                className="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400"
              >
                <LogIn size={18} className="mr-2" />
                Login
              </button>
              <button 
                onClick={() => navigateTo('register')}
                className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors"
              >
                <UserPlus size={18} className="mr-2" />
                Cadastrar
              </button>
            </div>
          )}
        </div>
        
        {/* Botão do Menu Mobile */}
        <div className="md:hidden flex items-center space-x-2">
          <button onClick={toggleTheme} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
            {theme === 'light' ? <Moon size={20} /> : <Sun size={20} />}
          </button>
          <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="text-gray-700 dark:text-gray-300">
            {mobileMenuOpen ? <X size={28} /> : <Menu size={28} />}
          </button>
        </div>
      </nav>

      {/* Menu Mobile Dropdown */}
      {mobileMenuOpen && (
        <div className="md:hidden bg-white dark:bg-gray-800 shadow-lg pb-4 px-4 space-y-4 animate-slide-down">
          {navLinks.map(link => <NavLinkItem key={link.page} {...link} />)}
          <hr className="dark:border-gray-700"/>
          {user ? (
            <div className="flex flex-col space-y-3">
               <div className="flex items-center space-x-3">
                <img 
                  src={appUser?.photoURL || `https://placehold.co/40x40/EBF4FF/76A9FA?text=${appUser?.firstName?.[0] || 'U'}`} 
                  alt="Perfil" 
                  className="w-10 h-10 rounded-full object-cover border-2 border-blue-500"
                />
                <span className="font-medium">{appUser?.firstName}</span>
              </div>
              <button 
                onClick={handleLogout} 
                className="flex items-center justify-center px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition-colors"
              >
                <LogOut size={18} className="mr-2" />
                Sair
              </button>
            </div>
          ) : (
            <div className="flex flex-col space-y-3">
              <button 
                onClick={() => { navigateTo('login'); setMobileMenuOpen(false); }}
                className="flex items-center justify-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400"
              >
                <LogIn size={18} className="mr-2" />
                Login
              </button>
              <button 
                onClick={() => { navigateTo('register'); setMobileMenuOpen(false); }}
                className="flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors"
              >
                <UserPlus size={18} className="mr-2" />
                Cadastrar
              </button>
            </div>
          )}
        </div>
      )}
    </header>
  );
};

const Footer = () => (
  <footer className="bg-white dark:bg-gray-800 shadow-inner py-6 mt-12">
    <div className="container mx-auto px-4 text-center text-gray-600 dark:text-gray-400">
      <p>&copy; {new Date().getFullYear()} FinControl. Todos os direitos reservados.</p>
      <p>Seu assistente financeiro pessoal.</p>
    </div>
  </footer>
);

// --- PÁGINAS ---

// Página: Landing
const LandingPage = () => {
  const { navigateTo } = useContext(AppContext);
  return (
    <div className="text-center">
      <div className="py-16 md:py-24">
        <h1 className="text-4xl md:text-6xl font-extrabold text-gray-900 dark:text-white mb-6 animate-fade-in-up">
          Tome o Controle da sua Vida Financeira
        </h1>
        <p className="text-lg md:text-xl text-gray-700 dark:text-gray-300 mb-10 max-w-2xl mx-auto animate-fade-in-up" style={{ animationDelay: '300ms' }}>
          FinControl é a ferramenta intuitiva que você precisava para organizar suas receitas,
          controlar seus gastos e alcançar seus objetivos financeiros com gráficos claros e profissionais.
        </p>
        <button 
          onClick={() => navigateTo('register')}
          className="px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105 animate-fade-in-up" 
          style={{ animationDelay: '600ms' }}
        >
          Comece Agora (É Grátis)
        </button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8 text-left mt-16">
        <FeatureCard 
          icon={<BarChart3 size={40} className="text-blue-500" />}
          title="Gráficos Profissionais"
          description="Visualize seus dados financeiros com gráficos de barra e rosca que facilitam o entendimento."
        />
        <FeatureCard 
          icon={<CreditCard size={40} className="text-green-500" />}
          title="Gestão de Gastos"
          description="Cadastre todas as suas receitas e despesas de forma rápida e categorize seus gastos."
        />
        <FeatureCard 
          icon={<Shield size={40} className="text-red-500" />}
          title="Seguro e Confiável"
          description="Seus dados são protegidos com a tecnologia Firebase, garantindo privacidade e segurança."
        />
      </div>
    </div>
  );
};

const FeatureCard = ({ icon, title, description }) => (
  <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
    <div className="mb-4">{icon}</div>
    <h3 className="text-xl font-bold mb-2 text-gray-900 dark:text-white">{title}</h3>
    <p className="text-gray-600 dark:text-gray-400">{description}</p>
  </div>
);

// Página: Login
const LoginPage = () => {
  const { navigateTo, showNotification } = useContext(AppContext);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [showPassword, setShowPassword] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    if (!email || !password) {
      showNotification('Por favor, preencha todos os campos.', 'error');
      return;
    }
    setIsLoading(true);
    try {
      await signInWithEmailAndPassword(auth, email, password);
      // O onAuthStateChanged vai cuidar do redirecionamento
      showNotification('Login realizado com sucesso!', 'success');
    } catch (error) {
      console.error("Erro no login:", error);
      let message = 'Ocorreu um erro ao fazer login.';
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
        message = 'E-mail ou senha inválidos.';
      }
      showNotification(message, 'error');
      setIsLoading(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <DollarSign size={40} className="text-blue-600 dark:text-blue-400" />
        <h2 className="text-3xl font-bold text-center mt-2">Login no FinControl</h2>
        <p className="text-gray-600 dark:text-gray-400 text-center">Bem-vindo de volta!</p>
      </CardHeader>
      <CardBody>
        <form onSubmit={handleLogin} className="space-y-4">
          <Input 
            id="email"
            type="email" 
            label="E-mail" 
            value={email} 
            onChange={(e) => setEmail(e.target.value)} 
            icon={<User />}
            placeholder="seu@email.com"
          />
          <Input 
            id="password"
            type={showPassword ? 'text' : 'password'}
            label="Senha" 
            value={password} 
            onChange={(e) => setPassword(e.target.value)} 
            icon={showPassword ? <EyeOff /> : <Eye />}
            onIconClick={() => setShowPassword(!showPassword)}
            placeholder="Sua senha"
          />
          <button 
            type="submit" 
            disabled={isLoading}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center"
          >
            {isLoading ? <LoadingSpinner /> : 'Entrar'}
          </button>
        </form>
      </CardBody>
      <CardFooter>
        <p>Não tem uma conta? 
          <button onClick={() => navigateTo('register')} className="text-blue-600 dark:text-blue-400 hover:underline font-medium ml-1">
            Cadastre-se
          </button>
        </p>
      </CardFooter>
    </Card>
  );
};

// Página: Registro
const RegisterPage = () => {
  const { navigateTo, showNotification } = useContext(AppContext);
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    password: '',
    confirmPassword: ''
  });
  const [isLoading, setIsLoading] = useState(false);
  
  const handleChange = (e) => {
    const { id, value } = e.target;
    setFormData(prev => ({ ...prev, [id]: value }));
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    const { firstName, lastName, email, phone, password, confirmPassword } = formData;

    if (!firstName || !lastName || !email || !phone || !password || !confirmPassword) {
      showNotification('Por favor, preencha todos os campos.', 'error');
      return;
    }
    if (password !== confirmPassword) {
      showNotification('As senhas não coincidem.', 'error');
      return;
    }
    if (password.length < 6) {
      showNotification('A senha deve ter pelo menos 6 caracteres.', 'error');
      return;
    }

    setIsLoading(true);
    try {
      // 1. Criar usuário no Firebase Auth
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // 2. Criar perfil do usuário no Firestore (coleção privada)
      const userProfileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/data`);
      await setDoc(userProfileRef, {
        uid: user.uid,
        firstName,
        lastName,
        email,
        phone,
        photoURL: '',
        isAdmin: false, // Por padrão, usuários não são admins
        createdAt: serverTimestamp()
      });

      // 3. Criar entrada na lista pública de usuários (para o Admin)
      const userListRef = doc(db, `/artifacts/${appId}/public/data/userList`, user.uid);
      await setDoc(userListRef, {
        uid: user.uid,
        name: `${firstName} ${lastName}`,
        email,
        isAdmin: false,
        joinedAt: serverTimestamp()
      });

      // O onAuthStateChanged vai cuidar do redirecionamento
      showNotification('Cadastro realizado com sucesso!', 'success');
    
    } catch (error) {
      console.error("Erro no cadastro:", error);
      let message = 'Ocorreu um erro ao cadastrar.';
      if (error.code === 'auth/email-already-in-use') {
        message = 'Este e-mail já está em uso.';
      }
      showNotification(message, 'error');
      setIsLoading(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <UserPlus size={40} className="text-blue-600 dark:text-blue-400" />
        <h2 className="text-3xl font-bold text-center mt-2">Crie sua Conta</h2>
        <p className="text-gray-600 dark:text-gray-400 text-center">Comece a organizar suas finanças.</p>
      </CardHeader>
      <CardBody>
        <form onSubmit={handleRegister} className="space-y-4">
          <div className="flex space-x-4">
            <Input id="firstName" type="text" label="Nome" value={formData.firstName} onChange={handleChange} placeholder="Seu nome" />
            <Input id="lastName" type="text" label="Sobrenome" value={formData.lastName} onChange={handleChange} placeholder="Seu sobrenome" />
          </div>
          <Input id="email" type="email" label="E-mail" value={formData.email} onChange={handleChange} placeholder="seu@email.com" />
          <Input id="phone" type="tel" label="Telefone" value={formData.phone} onChange={handleChange} placeholder="(XX) XXXXX-XXXX" />
          <Input id="password" type="password" label="Senha" value={formData.password} onChange={handleChange} placeholder="Mínimo 6 caracteres" />
          <Input id="confirmPassword" type="password" label="Confirmar Senha" value={formData.confirmPassword} onChange={handleChange} placeholder="Repita a senha" />
          
          <button 
            type="submit" 
            disabled={isLoading}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center"
          >
            {isLoading ? <LoadingSpinner /> : 'Cadastrar'}
          </button>
        </form>
      </CardBody>
      <CardFooter>
        <p>Já tem uma conta? 
          <button onClick={() => navigateTo('login')} className="text-blue-600 dark:text-blue-400 hover:underline font-medium ml-1">
            Faça login
          </button>
        </p>
      </CardFooter>
    </Card>
  );
};

// Página: Dashboard
const DashboardPage = () => {
  const { appUser, userId, showNotification, theme } = useContext(AppContext);
  const [transactions, setTransactions] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);

  // Escuta as transações do usuário em tempo real
  useEffect(() => {
    if (!userId) return;

    setIsLoading(true);
    const collectionPath = `/artifacts/${appId}/users/${userId}/transactions`;
    const q = query(collection(db, collectionPath)); // Pode-se adicionar orderBy('date', 'desc') se um índice for criado

    const unsubscribe = onSnapshot(q, (querySnapshot) => {
      const trans = [];
      querySnapshot.forEach((doc) => {
        trans.push({ id: doc.id, ...doc.data() });
      });
      // Ordena manualmente para evitar necessidade de índice no Firestore
      trans.sort((a, b) => (b.date.toDate ? b.date.toDate() : new Date(b.date)) - (a.date.toDate ? a.date.toDate() : new Date(a.date)));
      setTransactions(trans);
      setIsLoading(false);
    }, (error) => {
      console.error("Erro ao buscar transações:", error);
      showNotification("Erro ao carregar transações.", "error");
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, [userId, showNotification, appId]);

  // Cálculos para os cards e gráficos (memorizados)
  const financialSummary = useMemo(() => {
    const revenue = transactions
      .filter(t => t.type === 'revenue')
      .reduce((acc, t) => acc + t.amount, 0);
    const expense = transactions
      .filter(t => t.type === 'expense')
      .reduce((acc, t) => acc + t.amount, 0);
    const balance = revenue - expense;
    return { revenue, expense, balance };
  }, [transactions]);

  // Dados para o gráfico de despesas por categoria
  const categoryData = useMemo(() => {
    const expenses = transactions.filter(t => t.type === 'expense');
    const grouped = expenses.reduce((acc, t) => {
      const category = t.category || 'Outros';
      acc[category] = (acc[category] || 0) + t.amount;
      return acc;
    }, {});

    return Object.entries(grouped).map(([name, value]) => ({ name, value }));
  }, [transactions]);
  
  // Dados para o gráfico de Receita x Despesa (últimos 6 meses)
  const monthlyData = useMemo(() => {
    const months = {};
    const today = new Date();
    
    // Inicializa os últimos 6 meses
    for (let i = 5; i >= 0; i--) {
        const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthName = d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
        months[monthName] = { name: monthName, Receita: 0, Despesa: 0 };
    }
    
    transactions.forEach(t => {
        const tDate = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const monthName = tDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });

        if (months[monthName]) {
            if (t.type === 'revenue') {
                months[monthName].Receita += t.amount;
            } else {
                months[monthName].Despesa += t.amount;
            }
        }
    });

    return Object.values(months);
  }, [transactions]);

  // Ações
  const handleAddTransaction = async (transaction) => {
    try {
      const collectionPath = `/artifacts/${appId}/users/${userId}/transactions`;
      await addDoc(collection(db, collectionPath), {
        ...transaction,
        createdAt: serverTimestamp()
      });
      showNotification('Transação adicionada!', 'success');
      setIsModalOpen(false);
    } catch (error) {
      console.error("Erro ao adicionar transação:", error);
      showNotification('Erro ao salvar transação.', 'error');
    }
  };

  const handleDeleteTransaction = async (id) => {
    // Simulação de confirmação, já que window.confirm() é proibido
    // A lógica de confirmação real está no componente TransactionList
    
    const docRef = doc(db, `/artifacts/${appId}/users/${userId}/transactions`, id);
    try {
      await deleteDoc(docRef);
      // A notificação de sucesso será mostrada pelo onSnapshot atualizando a lista
      showNotification('Transação excluída!', 'success');
    } catch (error) {
      console.error("Erro ao excluir transação:", error);
      showNotification('Erro ao excluir transação.', 'error');
    }
    
    // // Implementação com confirmação (ideal):
    // if (window.confirm("Tem certeza que deseja excluir esta transação?")) {
    //   const docRef = doc(db, `/artifacts/${appId}/users/${userId}/transactions`, id);
    //   try {
    //     await deleteDoc(docRef);
    //     showNotification('Transação excluída!', 'success');
    //   } catch (error) {
    //     console.error("Erro ao excluir transação:", error);
    //     showNotification('Erro ao excluir transação.', 'error');
    //   }
    // }
  };

  if (isLoading) {
    return <LoadingSpinner />;
  }

  return (
    <div className="space-y-8">
      {/* Header do Dashboard */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
        <div>
          <h1 className="text-3xl font-bold text-gray-900 dark:text-white">
            Bem-vindo, {appUser?.firstName || 'Usuário'}!
          </h1>
          <p className="text-gray-600 dark:text-gray-400">Aqui está seu resumo financeiro.</p>
        </div>
        <button 
          onClick={() => setIsModalOpen(true)}
          className="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors transform hover:scale-105"
        >
          <Plus size={20} className="mr-2" />
          Adicionar Transação
        </button>
      </div>

      {/* Cards de Resumo */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <SummaryCard 
          title="Receita Total"
          amount={financialSummary.revenue}
          icon={<ArrowUpCircle size={32} className="text-green-500" />}
          color="text-green-500"
        />
        <SummaryCard 
          title="Despesa Total"
          amount={financialSummary.expense}
          icon={<ArrowDownCircle size={32} className="text-red-500" />}
          color="text-red-500"
        />
        <SummaryCard 
          title="Saldo Atual"
          amount={financialSummary.balance}
          icon={<DollarSign size={32} className="text-blue-500" />}
          color={financialSummary.balance >= 0 ? "text-blue-500" : "text-red-500"}
        />
      </div>

      {/* Gráficos */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <ChartContainer title="Receita vs. Despesa (Últimos 6 Meses)">
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={monthlyData} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
              <XAxis dataKey="name" stroke={theme === 'light' ? '#374151' : '#d1d5db'} />
              <YAxis stroke={theme === 'light' ? '#374151' : '#d1d5db'} />
              <Tooltip 
                contentStyle={{ 
                  backgroundColor: theme === 'light' ? '#ffffff' : '#1f2937', 
                  borderColor: theme === 'light' ? '#e5e7eb' : '#374151' 
                }} 
              />
              <Legend />
              <Bar dataKey="Receita" fill="#22c55e" radius={[4, 4, 0, 0]} />
              <Bar dataKey="Despesa" fill="#ef4444" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </ChartContainer>

        <ChartContainer title="Despesas por Categoria">
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie
                data={categoryData}
                cx="50%"
                cy="50%"
                innerRadius={60}
                outerRadius={100}
                fill="#8884d8"
                paddingAngle={5}
                dataKey="value"
                label={({ name, percent }) => `${name} (${(percent * 100).toFixed(0)}%)`}
              >
                {categoryData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />
                ))}
              </Pie>
              <Tooltip 
                contentStyle={{ 
                  backgroundColor: theme === 'light' ? '#ffffff' : '#1f2937', 
                  borderColor: theme === 'light' ? '#e5e7eb' : '#374151' 
                }}
              />
            </PieChart>
          </ResponsiveContainer>
        </ChartContainer>
      </div>

      {/* Lista de Transações Recentes */}
      <TransactionList 
        transactions={transactions.slice(0, 10)} // Mostra as 10 mais recentes
        onDelete={handleDeleteTransaction}
      />
      
      {/* Modal de Adicionar Transação */}
      <TransactionModal 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        onSubmit={handleAddTransaction} 
      />
    </div>
  );
};

// Página: Perfil
const ProfilePage = () => {
  const { appUser, userId, showNotification } = useContext(AppContext);
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    phone: '',
    photoURL: ''
  });
  const [isLoading, setIsLoading] = useState(false);

  // Carrega dados do usuário no formulário
  useEffect(() => {
    if (appUser) {
      setFormData({
        firstName: appUser.firstName || '',
        lastName: appUser.lastName || '',
        phone: appUser.phone || '',
        photoURL: appUser.photoURL || ''
      });
    }
  }, [appUser]);

  const handleChange = (e) => {
    const { id, value } = e.target;
    setFormData(prev => ({ ...prev, [id]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    
    try {
      // 1. Atualizar perfil privado
      const profileRef = doc(db, `/artifacts/${appId}/users/${userId}/profile/data`);
      await updateDoc(profileRef, {
        ...formData
      });
      
      // 2. Atualizar lista pública (apenas nome)
      const listRef = doc(db, `/artifacts/${appId}/public/data/userList`, userId);
      await updateDoc(listRef, {
        name: `${formData.firstName} ${formData.lastName}`
      });

      showNotification('Perfil atualizado com sucesso!', 'success');
      // O appUser no contexto será atualizado automaticamente se tivéssemos um listener nele,
      // mas por simplicidade, teremos que recarregar a página (ou atualizar o contexto manualmente)
      // Para este app, a atualização é local e o usuário verá a mudança no próximo login.
      // Solução simples: forçar recarga (não ideal em React, mas funciona)
      // window.location.reload(); 
      // Solução melhor: Atualizar o appUser no contexto. (Não implementado aqui para simplicidade)

    } catch (error) {
      console.error("Erro ao atualizar perfil:", error);
      showNotification('Erro ao atualizar perfil.', 'error');
    } finally {
      setIsLoading(false);
    }
  };

  if (!appUser) return <LoadingSpinner />;

  return (
    <div className="max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Meu Perfil</h1>
      <Card>
        <CardBody>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="flex justify-center mb-6">
              <img 
                src={formData.photoURL || `https://placehold.co/128x128/EBF4FF/76A9FA?text=${formData.firstName?.[0] || 'U'}`} 
                alt="Foto do Perfil" 
                className="w-32 h-32 rounded-full object-cover border-4 border-blue-500 shadow-lg"
                onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/128x128/EBF4FF/76A9FA?text=${formData.firstName?.[0] || 'U'}`}}
              />
            </div>
            
            <Input 
              id="photoURL"
              type="text" 
              label="URL da Foto do Perfil" 
              value={formData.photoURL} 
              onChange={handleChange} 
              placeholder="https://sua-imagem.com/foto.png"
            />
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <Input id="firstName" type="text" label="Nome" value={formData.firstName} onChange={handleChange} />
              <Input id="lastName" type="text" label="Sobrenome" value={formData.lastName} onChange={handleChange} />
            </div>
            
            <Input id="email" type="email" label="E-mail" value={appUser.email} disabled={true} />
            <Input id="phone" type="tel" label="Telefone" value={formData.phone} onChange={handleChange} />

            <button 
              type="submit" 
              disabled={isLoading}
              className="w-full flex items-center justify-center bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-blue-300"
            >
              <Save size={18} className="mr-2" />
              {isLoading ? 'Salvando...' : 'Salvar Alterações'}
            </button>
          </form>
        </CardBody>
      </Card>
    </div>
  );
};

// Página: Admin
const AdminPage = () => {
  const { appUser, isAdmin, showNotification, appId } = useContext(AppContext);
  const [users, setUsers] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  // Escuta a lista pública de usuários
  useEffect(() => {
    if (!isAdmin) {
      setIsLoading(false);
      return;
    }

    const collectionPath = `/artifacts/${appId}/public/data/userList`;
    const q = query(collection(db, collectionPath));

    const unsubscribe = onSnapshot(q, (querySnapshot) => {
      const userList = [];
      querySnapshot.forEach((doc) => {
        userList.push({ id: doc.id, ...doc.data() });
      });
      setUsers(userList);
      setIsLoading(false);
    }, (error) => {
      console.error("Erro ao buscar usuários:", error);
      showNotification("Erro ao carregar lista de usuários.", "error");
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, [isAdmin, showNotification, appId]);

  // Ação: Tornar/Remover Admin
  const toggleAdminStatus = async (userToUpdate) => {
    const newAdminStatus = !userToUpdate.isAdmin;
    
    // Não permitir que o próprio usuário remova seu admin
    if (userToUpdate.id === appUser.uid) {
      showNotification('Você não pode remover seu próprio status de administrador.', 'error');
      return;
    }

    try {
      // 1. Atualiza lista pública
      const listRef = doc(db, `/artifacts/${appId}/public/data/userList`, userToUpdate.id);
      await updateDoc(listRef, { isAdmin: newAdminStatus });
      
      // 2. Atualiza perfil privado
      const profileRef = doc(db, `/artifacts/${appId}/users/${userToUpdate.id}/profile/data`);
      await updateDoc(profileRef, { isAdmin: newAdminStatus });
      
      showNotification(`Usuário ${userToUpdate.name} agora é ${newAdminStatus ? 'Administrador' : 'Usuário padrão'}.`, 'success');
    
    } catch (error) {
      console.error("Erro ao atualizar status do admin:", error);
      showNotification('Erro ao atualizar status do usuário.', 'error');
    }
  };

  if (isLoading) return <LoadingSpinner />;

  if (!isAdmin) {
    return (
      <div className="text-center">
        <AlertCircle size={64} className="mx-auto text-red-500 mb-4" />
        <h1 className="text-3xl font-bold text-red-500">Acesso Negado</h1>
        <p className="text-lg text-gray-700 dark:text-gray-300 mt-2">
          Você não tem permissão para acessar esta página.
        </p>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto">
      <h1 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Gerenciamento de Usuários</h1>
      <Card>
        <CardBody>
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead className="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <Th>Nome</Th>
                  <Th>Email</Th>
                  <Th>Status</Th>
                  <Th>Ação</Th>
                </tr>
              </thead>
              <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {users.map((user) => (
                  <tr key={user.id}>
                    <Td>{user.name}</Td>
                    <Td>{user.email}</Td>
                    <Td>
                      <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                        user.isAdmin 
                        ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' 
                        : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'
                      }`}>
                        {user.isAdmin ? 'Admin' : 'Usuário'}
                      </span>
                    </Td>
                    <Td>
                      <button 
                        onClick={() => toggleAdminStatus(user)}
                        disabled={user.id === appUser.uid}
                        className={`px-3 py-1 rounded-md text-white transition-colors ${
                          user.isAdmin
                          ? 'bg-yellow-500 hover:bg-yellow-600'
                          : 'bg-green-500 hover:bg-green-600'
                        } disabled:bg-gray-400 disabled:cursor-not-allowed`}
                      >
                        {user.isAdmin ? 'Rebaixar' : 'Promover'}
                      </button>
                    </Td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </CardBody>
      </Card>
    </div>
  );
};

// Página: Sobre
const AboutPage = () => (
  <div className="max-w-3xl mx-auto text-lg">
    <h1 className="text-4xl font-bold mb-6 text-gray-900 dark:text-white">Sobre o FinControl</h1>
    <Card>
      <CardBody className="space-y-4 text-gray-700 dark:text-gray-300 leading-relaxed">
        <p>
          O FinControl nasceu da necessidade de uma ferramenta simples, intuitiva e poderosa
          para o gerenciamento financeiro pessoal. Em um mundo onde o controle das finanças
          é essencial para a tranquilidade e a realização de sonhos, nossa plataforma oferece
          a clareza que você precisa.
        </p>
        <p>
          Nossa missão é desmistificar o controle financeiro. Com gráficos profissionais,
          cadastro rápido de transações e um dashboard completo, queremos que você
          entenda para onde seu dinheiro está indo e tome decisões mais inteligentes
          sobre como usá-lo.
        </p>
        <p>
          Este projeto foi construído utilizando as tecnologias mais modernas, incluindo
          React, Firebase e Tailwind CSS, para garantir uma experiência rápida, segura e
          agradável em qualquer dispositivo.
        </p>
      </CardBody>
    </Card>
  </div>
);

// Página: Suporte
const SupportPage = () => (
  <div className="max-w-3xl mx-auto">
    <h1 className="text-4xl font-bold mb-6 text-gray-900 dark:text-white">Suporte</h1>
    <Card>
      <CardBody className="space-y-4 text-gray-700 dark:text-gray-300">
        <p className="text-lg">
          Encontrou algum problema ou tem alguma sugestão? Estamos aqui para ajudar!
        </p>
        <p>
          Por favor, entre em contato conosco através do nosso e-mail de suporte. Nossa equipe
          fará o possível para responder o mais rápido possível.
        </p>
        <div className="text-center my-6">
          <a 
            href="mailto:suporte@fincontrol.com" 
            className="inline-block px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
          >
            suporte@fincontrol.com
          </a>
        </div>
        <p className="text-center text-gray-600 dark:text-gray-400">
          Horário de atendimento: Segunda a Sexta, das 9h às 18h.
        </p>
      </CardBody>
    </Card>
  </div>
);


// --- COMPONENTES REUTILIZÁVEIS ---

// Card
const Card = ({ children }) => (
  <div className="w-full max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700">
    {children}
  </div>
);
const CardHeader = ({ children }) => <div className="p-6 md:p-8 border-b border-gray-200 dark:border-gray-700 flex flex-col items-center">{children}</div>;
const CardBody = ({ children, className = '' }) => <div className={`p-6 md:p-8 ${className}`}>{children}</div>;
const CardFooter = ({ children }) => <div className="p-6 md:p-8 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-center text-gray-600 dark:text-gray-400">{children}</div>;

// Input
const Input = ({ id, label, type, value, onChange, placeholder, icon, onIconClick, disabled = false }) => (
  <div className="w-full">
    {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>}
    <div className="relative">
      <input 
        type={type} 
        id={id} 
        value={value} 
        onChange={onChange} 
        placeholder={placeholder}
        disabled={disabled}
        className={`w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${icon ? 'pl-11' : ''} ${disabled ? 'bg-gray-200 dark:bg-gray-600 cursor-not-allowed' : ''}`}
      />
      {icon && (
        <div 
          className={`absolute inset-y-0 left-0 pl-3 flex items-center ${onIconClick ? 'cursor-pointer' : 'pointer-events-none'}`}
          onClick={onIconClick}
        >
          {React.cloneElement(icon, { className: "text-gray-400 dark:text-gray-500" })}
        </div>
      )}
    </div>
  </div>
);

// Select
const Select = ({ id, label, value, onChange, children }) => (
  <div>
    <label htmlFor={id} className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>
    <select 
      id={id} 
      value={value} 
      onChange={onChange}
      className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    >
      {children}
    </select>
  </div>
);

// Tabela Admin
const Th = ({ children }) => <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">{children}</th>;
const Td = ({ children }) => <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{children}</td>;

// Card de Resumo (Dashboard)
const SummaryCard = ({ title, amount, icon, color }) => (
  <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 flex items-center space-x-4">
    <div className="p-3 rounded-full bg-gray-100 dark:bg-gray-700">
      {icon}
    </div>
    <div>
      <p className="text-sm font-medium text-gray-600 dark:text-gray-400">{title}</p>
      <p className={`text-3xl font-bold ${color}`}>
        {amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
      </p>
    </div>
  </div>
);

// Container de Gráfico (Dashboard)
const ChartContainer = ({ title, children }) => (
  <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
    <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">{title}</h3>
    <div className="w-full h-full">
      {children}
    </div>
  </div>
);

// Lista de Transações (Dashboard)
const TransactionList = ({ transactions, onDelete }) => {
  const { showNotification } = useContext(AppContext);

  const getCategoryIcon = (category) => {
    const icons = {
      'Alimentação': <Utensils size={18} />,
      'Transporte': <Zap size={18} />, // Usando Zap para "eletricidade/movimento"
      'Lazer': <Gift size={18} />,
      'Moradia': <Home size={18} />,
      'Compras': <ShoppingBag size={18} />,
      'Salário': <DollarSign size={18} />,
      'Outros': <CreditCard size={18} />,
    };
    return icons[category] || <CreditCard size={18} />;
  };

  const [confirmDeleteId, setConfirmDeleteId] = useState(null);

  const handleDeleteClick = (id) => {
    if (confirmDeleteId === id) {
      // Segunda clique, deleta
      onDelete(id);
      setConfirmDeleteId(null);
    } else {
      // Primeiro clique, pede confirmação
      setConfirmDeleteId(id);
      showNotification('Clique novamente no ícone de lixeira para confirmar a exclusão.', 'info');
      // Reseta após 3 segundos
      setTimeout(() => setConfirmDeleteId(null), 3000);
    }
  };

  return (
    <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
      <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Transações Recentes</h3>
      <div className="space-y-4">
        {transactions.length === 0 ? (
          <p className="text-gray-600 dark:text-gray-400 text-center py-4">Nenhuma transação encontrada.</p>
        ) : (
          transactions.map(t => (
            <div key={t.id} className="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
              <div className="flex items-center space-x-3">
                <span className={`p-2 rounded-full ${t.type === 'revenue' ? 'bg-green-100 dark:bg-green-900 text-green-600' : 'bg-red-100 dark:bg-red-900 text-red-600'}`}>
                  {getCategoryIcon(t.category)}
                </span>
                <div>
                  <p className="font-semibold text-gray-800 dark:text-gray-200">{t.title}</p>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    {t.date.toDate ? t.date.toDate().toLocaleDateString('pt-BR') : new Date(t.date).toLocaleDateString('pt-BR')} - {t.category}
                  </p>
                </div>
              </div>
              <div className="flex items-center space-x-3">
                <span className={`font-bold ${t.type === 'revenue' ? 'text-green-600' : 'text-red-600'}`}>
                  {t.type === 'revenue' ? '+' : '-'} {t.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                </span>
                <button 
                  onClick={() => handleDeleteClick(t.id)}
                  className={`p-2 rounded-full ${confirmDeleteId === t.id ? 'bg-red-500 text-white' : 'text-gray-400 hover:bg-red-100 dark:hover:bg-red-900 dark:hover:text-red-400 hover:text-red-500'} transition-colors`}
                >
                  <Trash2 size={18} />
                </button>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );
};

// Modal de Transação
const TransactionModal = ({ isOpen, onClose, onSubmit }) => {
  const [type, setType] = useState('expense');
  const [title, setTitle] = useState('');
  const [amount, setAmount] = useState('');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [category, setCategory] = useState('Outros');

  const expenseCategories = ['Alimentação', 'Transporte', 'Lazer', 'Moradia', 'Compras', 'Outros'];
  const revenueCategories = ['Salário', 'Freelance', 'Investimentos', 'Outros'];

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!title || !amount || !date || !category) {
        // Acessa a função showNotification do contexto
        const appContext = useContext(AppContext);
        appContext.showNotification('Por favor, preencha todos os campos.', 'error');
        return;
    }
    onSubmit({
      title,
      amount: parseFloat(amount),
      type,
      date: new Date(date), // Salva como objeto Date
      category
    });
    // Reseta o formulário
    setTitle('');
    setAmount('');
    setDate(new Date().toISOString().split('T')[0]);
    setCategory(type === 'expense' ? 'Alimentação' : 'Salário'); // Reset inteligente
  };

  // Ajusta a categoria padrão quando o tipo muda
  useEffect(() => {
    if (type === 'expense') {
      setCategory('Alimentação');
    } else {
      setCategory('Salário');
    }
  }, [type]);


  if (!isOpen) return null;

  return (
    <div 
      className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
      onClick={onClose}
    >
      <div 
        className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md m-4 animate-scale-in"
        onClick={(e) => e.stopPropagation()} // Impede o fechamento ao clicar dentro do modal
      >
        <div className="flex justify-between items-center p-4 border-b dark:border-gray-700">
          <h3 className="text-xl font-bold text-gray-900 dark:text-white">Nova Transação</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
            <X size={24} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          {/* Tipo de Transação */}
          <div className="grid grid-cols-2 gap-2 rounded-lg bg-gray-100 dark:bg-gray-700 p-1">
            <button 
              type="button" 
              onClick={() => setType('expense')}
              className={`py-2 rounded-md font-medium transition-colors ${type === 'expense' ? 'bg-red-500 text-white shadow' : 'text-gray-700 dark:text-gray-300'}`}
            >
              Despesa
            </button>
            <button 
              type="button" 
              onClick={() => setType('revenue')}
              className={`py-2 rounded-md font-medium transition-colors ${type === 'revenue' ? 'bg-green-500 text-white shadow' : 'text-gray-700 dark:text-gray-300'}`}
            >
              Receita
            </button>
          </div>

          <Input id="title" label="Título" type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="Ex: Almoço" required />
          <Input id="amount" label="Valor (R$)" type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0,00" required step="0.01" min="0.01" />
          <Input id="date" label="Data" type="date" value={date} onChange={(e) => setDate(e.target.value)} required />
          
          <Select id="category" label="Categoria" value={category} onChange={(e) => setCategory(e.target.value)} required>
            <option value="" disabled>Selecione uma categoria</option>
            {(type === 'expense' ? expenseCategories : revenueCategories).map(cat => (
              <option key={cat} value={cat}>{cat}</option>
            ))}
          </Select>

          <button 
            type="submit" 
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
          >
            Adicionar Transação
          </button>
        </form>
      </div>
    </div>
  );
};

// --- Outros ---
const PIE_COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6'];

// Adiciona animações CSS
const style = document.createElement('style');
style.innerHTML = `
  @keyframes slide-in {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  .animate-slide-in { animation: slide-in 0.3s ease-out forwards; }
  
  @keyframes slide-down {
    from { transform: translateY(-20%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .animate-slide-down { animation: slide-down 0.3s ease-out forwards; }
  
  @keyframes fade-in-up {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
  
  @keyframes scale-in {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .animate-scale-in { animation: scale-in 0.2s ease-out forwards; }
  
  /* Estilos para o modo escuro */
  :root {
    color-scheme: light;
  }
  .dark {
    color-scheme: dark;
  }
  
  /* Fonte Inter */
  body {
    font-family: 'Inter', sans-serif;
  }
  
  /* Adiciona fonte Inter do Google Fonts se não estiver presente */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
`;
document.head.appendChild(style);


// Componente principal que renderiza o App
export default function App() {
  return (
    <AppProvider>
      <Router />
    </AppProvider>
  );
}